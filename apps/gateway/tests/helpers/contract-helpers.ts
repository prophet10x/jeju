/**
 * @fileoverview Contract test helper functions
 * @module gateway/tests/helpers/contract-helpers
 */

import type { PublicClient, WalletClient } from 'viem';

// Minimal ERC20 bytecode (OpenZeppelin-style with constructor args)
// This is the bytecode for a simple ERC20 with name, symbol, and initial supply
const ERC20_BYTECODE = '0x60806040523480156200001157600080fd5b506040516200124538038062001245833981810160405281019062000037919062000331565b8282816003908162000048919062000618565b5080600490620000579190620006185b505050620000703362000078640100000000026401000000009004565b5050506200073c565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6001600160a01b038216620001215760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f206164647265737300604482015260640160405180910390fd5b80600260008282546200013591906200070f565b90915550506001600160a01b038216600090815260208190526040812080548392906200016490849062000729565b90915550506040518181526001600160a01b038316906000907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9060200160405180910390a35050565b634e487b7160e01b600052604160045260246000fd5b600082601f830112620001d657600080fd5b81516001600160401b0380821115620001f357620001f3620001ae565b604051601f8301601f19908116603f011681019082821181831017156200021e576200021e620001ae565b816040528381526020925086838588010111156200023b57600080fd5b600091505b838210156200025f578582018301518183018401529082019062000240565b600093810190920192909252949350505050565b600080600080608085870312156200028a57600080fd5b84516001600160401b0380821115620002a257600080fd5b620002b088838901620001c4565b95506020870151915080821115620002c757600080fd5b50620002d687828801620001c4565b935050604085015191506060850151620002f08162000724565b939692955090935050565b600060018060a01b0382165b92915050565b600062000307826200002fb565b90506200030782620002fb565b6200032b816200030d565b81146200033757600080fd5b50565b600080600080608085870312156200035157600080fd5b84516001600160401b03808211156200036957600080fd5b6200037788838901620001c4565b955060208701519150808211156200038e57600080fd5b506200039d87828801620001c4565b9350506040850151915060608501516200030d81620003bc565b600181811c90821680620003cc57607f821691505b602082108103620003ed57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111562000441576000816000526020600020601f850160051c810160208610156200041e5750805b601f850160051c820191505b818110156200043f578281556001016200042a565b505b505050565b81516001600160401b03811115620004625762000462620001ae565b6200047a81620004738454620003b7565b84620003f3565b602080601f831160018114620004b257600084156200049957508584015190505b600019600386901b1c1916600185901b1785556200043f565b600085815260208120601f198616915b82811015620004e357888601518255948401946001909101908401620004c2565b5085821015620005025787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052601160045260246000fd5b808201808211156200030757620003076200050e565b80820281158282048414176200030757620003076200050e565b6000826200056f57634e487b7160e01b600052601260045260246000fd5b500490565b610afa806200014b6000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c806370a082311161008c57806395d89b411161006657806395d89b4114610182578063a457c2d71461018a578063a9059cbb1461019d578063dd62ed3e146101b057600080fd5b806370a082311461012c578063715018a6146101555780638da5cb5b1461015f57600080fd5b806306fdde03146100d4578063095ea7b3146100f257806318160ddd1461011557806323b872dd14610127578063313ce5671461013a578063395093511461011957600080fd5b3660006100d457600080fd5b600080fd5b6100dc6101c3565b6040516100e99190610903565b60405180910390f35b610105610100366004610974565b610255565b60405190151581526020016100e9565b6002545b6040519081526020016100e9565b61010561013536600461099e565b61026f565b60405160128152602001610e9565b61011961014a366004610974565b610293565b61015d6102b5565b005b6005546001600160a01b03165b6040516001600160a01b0390911681526020016100e9565b6100dc6102c9565b610105610198366004610974565b6102d8565b6101056101ab366004610974565b610358565b6101196101be3660046109da565b610366565b6060600380546101d290610a0d565b80601f01602080910402602001604051908101604052809291908181526020018280546101fe90610a0d565b801561024b5780601f106102205761010080835404028352916020019161024b565b820191906000526020600020905b81548152906001019060200180831161022e57829003601f168201915b5050505050905090565b600033610263818585610391565b60019150505b92915050565b60003361027d8582856104b5565b61028885858561052f565b506001949350505050565b6000336102638185856102a68383610366565b6102b09190610a47565b610391565b6102bd6106d3565b6102c7600061072d565b565b6060600480546101d290610a0d565b600033816102e68286610366565b90508381101561034b5760405162461bcd60e51b815260206004820152602560248201527f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f77604482015264207a65726f60d81b60648201526084015b60405180910390fd5b6102888286868403610391565b60003361026381858561052f565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6001600160a01b0383166103f35760405162461bcd60e51b8152602060048201526024808201527f45524332303a20617070726f76652066726f6d20746865207a65726f206164646044820152637265737360e01b6064820152608401610342565b6001600160a01b0382166104545760405162461bcd60e51b815260206004820152602260248201527f45524332303a20617070726f766520746f20746865207a65726f206164647265604482015261737360f01b6064820152608401610342565b6001600160a01b0383811660008181526001602090815260408083209487168084529482529182902085905590518481527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a3505050565b60006104c18484610366565b90506000198114610529578181101561051c5760405162461bcd60e51b815260206004820152601d60248201527f45524332303a20696e73756666696369656e7420616c6c6f77616e63650000006044820152606401610342565b6105298484848403610391565b50505050565b6001600160a01b0383166105935760405162461bcd60e51b815260206004820152602560248201527f45524332303a207472616e736665722066726f6d20746865207a65726f206164604482015264647265737360d81b6064820152608401610342565b6001600160a01b0382166105f55760405162461bcd60e51b815260206004820152602360248201527f45524332303a207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b6064820152608401610342565b6001600160a01b0383166000908152602081905260409020548181101561066d5760405162461bcd60e51b815260206004820152602660248201527f45524332303a207472616e7366657220616d6f756e7420657863656564732062604482015265616c616e636560d01b6064820152608401610342565b6001600160a01b03808516600090815260208190526040808220858503905591851681529081208054849290610693908490610a47565b92505081905550826001600160a01b0316846001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516106df91815260200190565b60405180910390a3610529565b6005546001600160a01b031633146102c75760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152606401610342565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6000815180845260005b8181101561077f57602081850181015186830182015201610763565b506000602082860101526020601f19601f83011685010191505092915050565b6020815260006107b2602083018461075d565b9392505050565b80356001600160a01b03811681146107d057600080fd5b919050565b600080604083850312156107e857600080fd5b6107f1836107b9565b946020939093013593505050565b60008060006060848603121561081457600080fd5b61081d846107b9565b925061082b602085016107b9565b9150604084013590509250925092565b6000806040838503121561084e57600080fd5b610857836107b9565b9150610865602084016107b9565b90509250929050565b600181811c9082168061088257607f821691505b6020821081036108a257634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052601160045260246000fd5b808201808211156102695761026961a8a856fea264697066735822122077777777777777777777777777777777777777777777777777777777777777777764736f6c63430008150033' as `0x${string}`;

const ERC20_ABI = [
  {
    type: 'constructor',
    inputs: [
      { name: 'name_', type: 'string' },
      { name: 'symbol_', type: 'string' },
      { name: 'initialSupply', type: 'uint256' },
      { name: 'owner', type: 'address' },
    ],
  },
] as const;

/**
 * Deploy ERC20 token for testing
 */
export async function deployTestToken(
  walletClient: WalletClient,
  name: string,
  symbol: string,
  initialSupply: bigint = 1000000n * 10n ** 18n
): Promise<`0x${string}`> {
  const account = walletClient.account;
  if (!account) {
    throw new Error('WalletClient must have an account');
  }

  // Deploy the contract
  const hash = await walletClient.deployContract({
    abi: ERC20_ABI,
    bytecode: ERC20_BYTECODE,
    args: [name, symbol, initialSupply, account.address],
  });

  // Wait for deployment (caller should use waitForTx)
  return hash;
}

/**
 * Get token balance
 */
export async function getTokenBalance(
  publicClient: PublicClient,
  tokenAddress: `0x${string}`,
  account: `0x${string}`
): Promise<bigint> {
  const balance = await publicClient.readContract({
    address: tokenAddress,
    abi: [{
      type: 'function',
      name: 'balanceOf',
      inputs: [{ name: 'account', type: 'address' }],
      outputs: [{ type: 'uint256' }],
      stateMutability: 'view',
    }],
    functionName: 'balanceOf',
    args: [account],
  });
  
  return balance as bigint;
}

/**
 * Approve token spending
 */
export async function approveToken(
  walletClient: WalletClient,
  tokenAddress: `0x${string}`,
  spender: `0x${string}`,
  amount: bigint
): Promise<`0x${string}`> {
  const hash = await walletClient.writeContract({
    address: tokenAddress,
    abi: [{
      type: 'function',
      name: 'approve',
      inputs: [
        { name: 'spender', type: 'address' },
        { name: 'amount', type: 'uint256' }
      ],
      outputs: [{ type: 'bool' }],
      stateMutability: 'nonpayable',
    }],
    functionName: 'approve',
    args: [spender, amount],
  });
  
  return hash;
}

/**
 * Wait for transaction receipt
 */
export async function waitForTx(
  publicClient: PublicClient,
  hash: `0x${string}`,
  confirmations: number = 1
): Promise<boolean> {
  const receipt = await publicClient.waitForTransactionReceipt({
    hash,
    confirmations,
  });
  
  return receipt.status === 'success';
}

/**
 * Check if address is valid contract
 */
export async function isContract(
  publicClient: PublicClient,
  address: `0x${string}`
): Promise<boolean> {
  const code = await publicClient.getBytecode({ address });
  return code !== undefined && code !== '0x';
}

/**
 * Get current block number
 */
export async function getCurrentBlock(publicClient: PublicClient): Promise<bigint> {
  return await publicClient.getBlockNumber();
}

/**
 * Mine blocks (for testing time-dependent features)
 */
export async function mineBlocks(publicClient: PublicClient, count: number): Promise<void> {
  // Send eth_mine RPC calls
  for (let i = 0; i < count; i++) {
    await publicClient.request({
      // @ts-expect-error - evm_mine not in standard RPC types
      method: 'evm_mine',
      params: [],
    });
  }
}

/**
 * Increase time (for testing time-locks)
 */
export async function increaseTime(publicClient: PublicClient, seconds: number): Promise<void> {
  await publicClient.request({
    // @ts-expect-error - evm_increaseTime not in standard RPC types
    method: 'evm_increaseTime',
    params: [seconds],
  });
  
  await mineBlocks(publicClient, 1);
}

/**
 * Snapshot and revert (for test isolation)
 */
export async function snapshot(publicClient: PublicClient): Promise<`0x${string}`> {
  const snapshotId = await publicClient.request({
    // @ts-expect-error - evm_snapshot not in standard RPC types
    method: 'evm_snapshot',
    params: [],
  });
  
  return snapshotId as `0x${string}`;
}

export async function revert(publicClient: PublicClient, snapshotId: `0x${string}`): Promise<void> {
  await publicClient.request({
    // @ts-expect-error - evm_revert not in standard RPC types
    method: 'evm_revert',
    params: [snapshotId],
  });
}


