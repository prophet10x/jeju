/**
 * Deploy Test ERC20 Token for Gateway Integration Testing
 * Creates a simple ERC20 token that can be used to test complete Gateway lifecycle
 */

import { existsSync, readFileSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { inferChainFromRpcUrl } from '@jejunetwork/deployment/scripts/shared/chain-utils'
import {
  createPublicClient,
  createWalletClient,
  encodeDeployData,
  formatEther,
  getBalance,
  getChainId,
  getContractAddress,
  http,
  parseAbi,
  parseEther,
  waitForTransactionReceipt,
} from 'viem'
import { privateKeyToAccount } from 'viem/accounts'

// Minimal ERC20 with mint capability for testing
const ERC20_ABI = [
  'constructor(string name, string symbol, uint256 initialSupply)',
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  'function decimals() view returns (uint8)',
  'function totalSupply() view returns (uint256)',
  'function balanceOf(address) view returns (uint256)',
  'function transfer(address to, uint256 amount) returns (bool)',
  'function approve(address spender, uint256 amount) returns (bool)',
  'function allowance(address owner, address spender) view returns (uint256)',
  'function transferFrom(address from, address to, uint256 amount) returns (bool)',
]

// Compiled bytecode for minimal ERC20 (Solidity 0.8.x)
const ERC20_BYTECODE =
  '0x60806040523480156200001157600080fd5b5060405162000d7738038062000d77833981810160405281019062000037919062000269565b828281600390816200004a9190620005ab565b5080600490816200005c9190620005ab565b5050506200007133826200007a60201b60201c565b50505062000759565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603620000ec576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620000e390620006f8565b60405180910390fd5b6200010060008383620001e860201b60201c565b80600260008282546200011491906200074a565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546200016b91906200074a565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051620001d29190620007a6565b60405180910390a3620001e460008383620001ed60201b60201c565b5050565b505050565b505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6200025c8262000211565b810181811067ffffffffffffffff821117156200027e576200027d62000222565b5b80604052505050565b60006200029362000202565b9050620002a1828262000251565b919050565b600067ffffffffffffffff821115620002c457620002c362000222565b5b620002cf8262000211565b9050602081019050919050565b60005b83811015620002fc578082015181840152602081019050620002df565b60008484015250505050565b6000620003196200031384620002a6565b62000287565b9050828152602081018484840111156200033857620003376200020c565b5b62000345848285620002dc565b509392505050565b600082601f83011262000365576200036462000207565b5b81516200037784826020860162000308565b91505092915050565b6000819050919050565b620003958162000380565b8114620003a157600080fd5b50565b600081519050620003b5816200038a565b92915050565b600080600060608486031215620003d757620003d66200020c565b5b600084015167ffffffffffffffff811115620003f857620003f762000201565b5b620004068682870162000350565b935050602084015167ffffffffffffffff8111156200042a57620004296200020106565b5b620004388682870162000350565b92505060406200044b86828701620003a4565b9150509250925092565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620004a857607f821691505b602082108103620004be57620004bd6200046057b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026200052a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620004eb565b620005368683620004eb565b95508019841693508086168417925050509392505050565b6000819050919050565b600062000579620005736200056d8462000380565b6200054e565b62000380565b9050919050565b6000819050919050565b620005958362000558565b620005ad620005a48262000580565b848454620004f8565b825550505050565b600090565b620005c4620005b5565b620005d18184846200058a565b505050565b5b81811015620005f957620005ed600082620005ba565b600181019050620005d7565b5050565b601f82111562000648576200061281620004c4565b6200061d84620004da565b810160208510156200062d578190505b620006456200063c85620004da565b830182620005d6565b50505b505050565b600082821c905092915050565b60006200066d600019846008026200064d565b1980831691505092915050565b60006200068883836200065a565b9150826002028217905092915050565b620006a38262000455565b67ffffffffffffffff811115620006bf57620006be62000222565b5b620006cb82546200048f565b620006d8828285620005fd565b600060209050601f831160018114620007105760008415620006fb578287015190505b6200070785826200067a565b86555062000777565b601f1984166200072086620004c4565b60005b828110156200074a5784890151825560018201915060208501945060208101905062000723565b868310156200076a578489015162000766601f8916826200065a565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200077c8262000380565b9150620007898362000380565b9250828201905080821115620007a457620007a36200077f565b5b92915050565b620007b58162000380565b82525050565b6000602082019050620007d26000830184620007aa565b92915050565b61060e80620007e86000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce5671461013457806370a082311461015257806395d89b4114610182578063a9059cbb146101a0578063dd62ed3e146101d057610093565b806306fdde0314610098578063095ea7b3146100b657806318160ddd146100e657806323b872dd14610104575b600080fd5b6100a0610200565b6040516100ad91906103c3565b60405180910390f35b6100d060048036038101906100cb919061047e565b610292565b6040516100dd91906104d9565b60405180910390f35b6100ee6102b5565b6040516100fb9190610503565b60405180910390f35b61011e6004803603810190610119919061051e565b6102bf565b60405161012b91906104d9565b60405180910390f35b61013c6102ee565b6040516101499190610587565b60405180910390f35b61016c600480360381019061016791906105a2565b6102f7565b6040516101799190610503565b60405180910390f35b61018a61033f565b60405161019791906103c3565b60405180910390f35b6101ba60048036038101906101b5919061047e565b6103d1565b6040516101c791906104d9565b60405180910390f35b6101ea60048036038101906101e591906105cf565b6103f4565b6040516101f79190610503565b60405180910390f35b60606003805461020f9061063e565b80601f016020809104026020016040519081016040528092919081815260200182805461023b9061063e565b80156102885780601f1061025d57610100808354040283529160200191610288565b820191906000526020600020905b81548152906001019060200180831161026b57829003601f168201915b5050505050905090565b60008061029d61047b565b90506102aa818585610483565b600191505092915050565b6000600254905090565b6000806102ca61047b565b90506102d7858285610495565b6102e2858585610529565b60019150509392505050565b60006012905090565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461034e9061063e565b80601f016020809104026020016040519081016040528092919081815260200182805461037a9061063e565b80156103c75780601f1061039c576101008083540402835291602001916103c7565b820191906000526020600020905b8154815290600101906020018083116103aa57829003601f168201915b5050505050905090565b6000806103dc61047b565b90506103e9818585610529565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b610490838383600161059f565b505050565b60006104a18484610776565b90506000198114610523578181101561051357828183846104c061047b565b73ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925856040516105059190610503565b60405180910390a4505b61052284848484036000610483565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141561059b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059290610690565b60405180910390fd5b50505050565b610483565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036105fa578254602052806000fd5b8254600052806001fd5b505050565b600082825260208201905092915050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b600061067a6025836105ff565b91506106858261061e565b604082019050919050565b600060208201905081810360008301526106a98161066d565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806106f757607f821691505b60208210810361070a576107096106b0565b5b50919050565b60008151905091905056fea26469706673582212200000000000000000000000000000000000000000000000000000000000000000000064736f6c63430008150033'

const RPC_URL = process.env.RPC_URL || 'http://localhost:6546'
const PRIVATE_KEY =
  process.env.PRIVATE_KEY ||
  '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80'

async function deployTestToken() {
  console.log('Deploying Test Token for Gateway Integration Tests\n')

  const chain = inferChainFromRpcUrl(RPC_URL)
  const account = privateKeyToAccount(PRIVATE_KEY as `0x${string}`)
  const publicClient = createPublicClient({ chain, transport: http(RPC_URL) })
  const walletClient = createWalletClient({
    chain,
    transport: http(RPC_URL),
    account,
  })

  console.log('Deployer:', account.address)
  const chainId = await getChainId(publicClient)
  console.log('Network:', chain.name, `(chainId: ${chainId})`)

  const balance = await getBalance(publicClient, { address: account.address })
  console.log('Balance:', formatEther(balance), 'ETH\n')

  if (balance === 0n) {
    console.error('Error: Deployer has no ETH balance')
    process.exit(1)
  }

  // Deploy ERC20 contract
  console.log('Deploying ERC20 token...')
  const abi = parseAbi(ERC20_ABI)

  const name = 'Test Token'
  const symbol = 'TEST'
  const initialSupply = parseEther('1000000') // 1M tokens

  const deployData = encodeDeployData({
    abi,
    bytecode: ERC20_BYTECODE as `0x${string}`,
    args: [name, symbol, initialSupply],
  })

  const hash = await walletClient.sendTransaction({ data: deployData })
  console.log('Transaction hash:', hash)

  const receipt = await waitForTransactionReceipt(publicClient, { hash })
  const testTokenAddress =
    receipt.contractAddress ??
    getContractAddress({ from: account.address, nonce: BigInt(0) })

  console.log('\nTest Token deployed:')
  console.log('  Address:', testTokenAddress)
  console.log('  Name:', name)
  console.log('  Symbol:', symbol)
  console.log('  Decimals: 18')
  console.log('  Initial Supply:', formatEther(initialSupply), symbol)

  // Update .env.local
  const envPath = join(process.cwd(), '.env.local')
  let envContent = ''

  if (existsSync(envPath)) {
    envContent = readFileSync(envPath, 'utf-8')
  }

  // Replace or add TEST_TOKEN_ADDRESS
  if (envContent.includes('TEST_TOKEN_ADDRESS=')) {
    envContent = envContent.replace(
      /TEST_TOKEN_ADDRESS=.*/g,
      `TEST_TOKEN_ADDRESS=${testTokenAddress}`,
    )
  } else {
    envContent += `\n# Test Token for Integration Testing\nTEST_TOKEN_ADDRESS=${testTokenAddress}\n`
  }

  writeFileSync(envPath, envContent)
  console.log('\nUpdated TEST_TOKEN_ADDRESS in .env.local')

  console.log('\nTest token ready for integration tests')
  console.log('\nNext steps:')
  console.log('  1. Run integration test: bun run test:e2e:real-integration')
  console.log('  2. Test will register token in TokenRegistry')
  console.log('  3. Test will deploy paymaster')
  console.log('  4. Test will add liquidity')
  console.log('  5. Test will register node')
}

deployTestToken().catch((error) => {
  console.error('Failed to deploy test token:', error)
  process.exit(1)
})
