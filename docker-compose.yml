# Jeju Infrastructure Stack
#
# Provides the full infrastructure for local development:
# - IPFS: Decentralized storage
# - CovenantSQL: Decentralized SQL database with BFT consensus
# - Cache Service: Redis-compatible cache
# - DA Server: Data availability with vault integration
# - JNS Gateway: Name resolution and frontend serving
# - PostgreSQL: For Indexer (Subsquid requirement only)
#
# Usage:
#   docker compose up -d
#   bun run dev

services:
  # ============================================================================
  # IPFS - Decentralized Storage
  # ============================================================================
  ipfs:
    image: ipfs/kubo:latest
    container_name: jeju-ipfs
    hostname: ipfs
    ports:
      - "4001:4001"     # Swarm
      - "4001:4001/udp" # Swarm UDP
      - "5001:5001"     # API
      - "4180:8080"     # Gateway
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    networks:
      - jeju
    healthcheck:
      test: ["CMD-SHELL", "ipfs dag stat /ipfs/QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # PostgreSQL - ONLY for Indexer (Subsquid requires it)
  # All other apps should use CovenantSQL
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: jeju-postgres
    hostname: postgres
    ports:
      - "5434:5432"  # Use 5434 to avoid conflicts with local postgres
    environment:
      - POSTGRES_USER=jeju
      - POSTGRES_PASSWORD=jeju_dev_password
      - POSTGRES_DB=jeju
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - jeju
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jeju -d jeju"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # CQL - Decentralized SQL Database
  # Local dev uses mock SQLite server; production uses full CovenantSQL
  # ============================================================================
  cql:
    build:
      context: ./packages/db
      dockerfile: Dockerfile.mock-cql
    container_name: jeju-cql
    hostname: cql
    ports:
      - "4661:4661"   # HTTP API
    environment:
      - CQL_PORT=4661
      - CQL_DATA_DIR=/data
    volumes:
      - cql-data:/data
    networks:
      - jeju
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4661/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Cache Service - Decentralized Redis-compatible Cache
  # ============================================================================
  cache-service:
    build:
      context: ./apps/storage/cache-service
      dockerfile: Dockerfile
    container_name: jeju-cache
    hostname: cache
    ports:
      - "4115:4015"  # Map to 4115 externally to avoid conflicts
    environment:
      - CACHE_SERVICE_PORT=4015
      - CACHE_DEFAULT_TTL=3600
      - CACHE_MAX_MEMORY_MB=512
      - LOG_LEVEL=info
    volumes:
      - cache-data:/data
    networks:
      - jeju
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:4015/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # DA Server - Data Availability with Vault
  # ============================================================================
  da-server:
    build:
      context: ./apps/storage/da-server
      dockerfile: Dockerfile
    container_name: jeju-da
    hostname: da
    ports:
      - "4010:4010"
    environment:
      - PORT=4010
      - IPFS_API_URL=http://ipfs:5001
      - IPFS_GATEWAY_URL=http://ipfs:8080
      - DATA_DIR=/data
      - VAULT_ENCRYPTION_SECRET=${VAULT_ENCRYPTION_SECRET:-dev-vault-secret-change-in-production}
      - LOG_LEVEL=info
    depends_on:
      ipfs:
        condition: service_healthy
    volumes:
      - da-data:/data
    networks:
      - jeju
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4010/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # JNS Gateway - Frontend Serving via JNS
  # ============================================================================
  jns-gateway:
    build:
      context: ./apps/gateway
      dockerfile: Dockerfile.jns
    container_name: jeju-jns-gateway
    hostname: jns-gateway
    ports:
      - "4005:4005"
    environment:
      - JNS_GATEWAY_PORT=4005
      - JEJU_RPC_URL=${JEJU_RPC_URL:-http://host.docker.internal:9545}
      - JNS_REGISTRY_ADDRESS=${JNS_REGISTRY_ADDRESS:-0x0000000000000000000000000000000000000000}
      - JNS_RESOLVER_ADDRESS=${JNS_RESOLVER_ADDRESS:-0x0000000000000000000000000000000000000000}
      - IPFS_GATEWAY_URL=http://ipfs:8080
      - CACHE_SERVICE_URL=http://cache:4015
    depends_on:
      ipfs:
        condition: service_healthy
    networks:
      - jeju
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # Compute Trigger Service
  # ============================================================================
  trigger-service:
    build:
      context: ./apps/compute
      dockerfile: Dockerfile.trigger
    container_name: jeju-triggers
    hostname: triggers
    ports:
      - "4016:4016"
    environment:
      - TRIGGER_PORT=4016
      - JEJU_RPC_URL=${JEJU_RPC_URL:-http://host.docker.internal:9545}
      - TRIGGER_REGISTRY_ADDRESS=${TRIGGER_REGISTRY_ADDRESS:-0x0000000000000000000000000000000000000000}
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - POLL_INTERVAL_MS=60000
      - MAX_CONCURRENT_EXECUTIONS=10
    networks:
      - jeju
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4016/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

networks:
  jeju:
    name: jeju
    driver: bridge

volumes:
  ipfs-data:
  cache-data:
  da-data:
  postgres-data:
  cql-data:
