name: Crucible CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/crucible/**'
      - '.github/workflows/crucible-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/crucible/**'

env:
  CI: true

jobs:
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: TypeScript type check
        working-directory: apps/crucible
        run: bun run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run unit tests
        working-directory: apps/crucible
        run: bun test src/tests/

  integration-tests:
    name: Integration Tests (with Anvil)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Build contracts
        working-directory: packages/contracts
        run: forge build

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --port 6546 &
          sleep 3
          curl -s http://localhost:6546 -X POST -H "Content-Type: application/json" --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'

      - name: Deploy test contracts
        working-directory: packages/contracts
        run: |
          forge script script/Deploy.s.sol:DeployScript --rpc-url http://localhost:6546 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

      - name: Run integration tests
        working-directory: apps/crucible
        env:
          RPC_URL: http://localhost:6546
          INTEGRATION: true
        run: bun test src/tests/integration.test.ts
