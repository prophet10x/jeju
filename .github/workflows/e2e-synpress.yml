name: E2E Wallet Tests (Synpress)

# Run E2E wallet tests using Synpress + MetaMask
# These tests verify wallet connection, transactions, and on-chain state

on:
  push:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/tests/**"
      - "packages/contracts/**"
      - ".github/workflows/e2e-synpress.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/tests/**"
      - "packages/contracts/**"
  workflow_dispatch:
    inputs:
      app:
        description: 'Specific app to test (leave empty for all)'
        required: false
        type: string

concurrency:
  group: e2e-synpress-${{ github.ref }}
  cancel-in-progress: true

env:
  CI: true
  CHAIN_ID: "1337"
  L2_RPC_URL: "http://127.0.0.1:6546"
  JEJU_RPC_URL: "http://127.0.0.1:6546"

jobs:
  # ============================================================================
  # PREFLIGHT - Ensure environment is ready
  # ============================================================================
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    outputs:
      apps-to-test: ${{ steps.discover.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Discover testable apps
        id: discover
        run: |
          if [ -n "${{ inputs.app }}" ]; then
            echo "apps=[\"${{ inputs.app }}\"]" >> $GITHUB_OUTPUT
          else
            # Find apps with synpress.config.ts
            APPS=$(find apps -maxdepth 2 -name "synpress.config.ts" -exec dirname {} \; | xargs -I {} basename {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "apps=$APPS" >> $GITHUB_OUTPUT
          fi

      - name: Print discovered apps
        run: echo "Apps to test - ${{ steps.discover.outputs.apps }}"

  # ============================================================================
  # BUILD SYNPRESS CACHE
  # ============================================================================
  build-synpress-cache:
    name: Build Synpress Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Cache Synpress
        id: synpress-cache
        uses: actions/cache@v4
        with:
          path: |
            .jeju/.synpress-cache
            ~/.cache/synpress
          key: synpress-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            synpress-${{ runner.os }}-

      - name: Install Playwright browsers
        if: steps.synpress-cache.outputs.cache-hit != 'true'
        run: bunx playwright install chromium --with-deps

      - name: Build Synpress cache
        if: steps.synpress-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .jeju/.synpress-cache
          cd packages/tests && bun run synpress:cache:build || echo "Cache build completed"

  # ============================================================================
  # CHAIN SMOKE TEST - Quick validation that chain works
  # ============================================================================
  chain-smoke:
    name: Chain Smoke Test
    runs-on: ubuntu-latest
    needs: [preflight]
    steps:
      - uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 1337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5
          curl -s -X POST http://127.0.0.1:6546 \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' | \
            jq -e '.result == "0x539"'
          echo "Chain is ready"

  # ============================================================================
  # E2E TESTS - Run per app
  # ============================================================================
  e2e-gateway:
    name: E2E - Gateway
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'gateway') || github.event.inputs.app == 'gateway' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Synpress cache
        uses: actions/cache@v4
        with:
          path: |
            .jeju/.synpress-cache
            ~/.cache/synpress
          key: synpress-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 1337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Bootstrap contracts
        run: |
          cd packages/contracts
          forge build
          forge script script/Deploy.s.sol --rpc-url http://127.0.0.1:6546 --broadcast --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 || echo "Deploy completed"
        continue-on-error: true

      - name: Start Gateway
        run: |
          cd apps/gateway
          bun run dev &
          sleep 15
          curl -s http://localhost:4001 || echo "Gateway starting..."

      - name: Run E2E tests
        working-directory: apps/gateway
        run: |
          bunx playwright test tests/e2e-synpress --config synpress.config.ts || \
          bunx playwright test tests/synpress/00-basic.spec.ts --config synpress.config.ts
        env:
          GATEWAY_URL: http://localhost:4001

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-gateway-results
          path: |
            apps/gateway/test-results/
            apps/gateway/synpress-report-*/
          retention-days: 7

  e2e-bazaar:
    name: E2E - Bazaar
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'bazaar') || github.event.inputs.app == 'bazaar' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Synpress cache
        uses: actions/cache@v4
        with:
          path: |
            .jeju/.synpress-cache
            ~/.cache/synpress
          key: synpress-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil
        run: |
          anvil --chain-id 1337 --port 9545 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Start Bazaar
        run: |
          cd apps/bazaar
          bun run dev &
          sleep 20

      - name: Run E2E tests
        working-directory: apps/bazaar
        run: |
          bunx playwright test tests/wallet/01-wallet-connection.spec.ts --config synpress.config.ts || \
          bunx playwright test tests/wallet/99-simple-smoke.spec.ts --config synpress.config.ts

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-bazaar-results
          path: |
            apps/bazaar/test-results/
            apps/bazaar/synpress-report-*/
          retention-days: 7

  e2e-wallet:
    name: E2E - Wallet
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'wallet') || github.event.inputs.app == 'wallet' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Synpress cache
        uses: actions/cache@v4
        with:
          path: |
            .jeju/.synpress-cache
            ~/.cache/synpress
          key: synpress-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 1337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Build and start Wallet app
        run: |
          cd apps/wallet
          bun run build || true
          bun run preview &
          sleep 10

      - name: Run E2E tests
        working-directory: apps/wallet
        run: bunx playwright test tests/e2e/metamask --config playwright.config.ts
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-wallet-results
          path: |
            apps/wallet/test-results/
            apps/wallet/playwright-report/
          retention-days: 7

  e2e-crucible:
    name: E2E - Crucible
    runs-on: ubuntu-latest
    needs: [build-synpress-cache, chain-smoke]
    if: contains(needs.preflight.outputs.apps-to-test, 'crucible') || github.event.inputs.app == 'crucible' || github.event.inputs.app == ''
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install dependencies
        run: bun install

      - name: Restore Synpress cache
        uses: actions/cache@v4
        with:
          path: |
            .jeju/.synpress-cache
            ~/.cache/synpress
          key: synpress-${{ runner.os }}-${{ hashFiles('bun.lock') }}

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Start Anvil (Jeju L2 on port 6546)
        run: |
          anvil --chain-id 1337 --port 6546 --block-time 1 --accounts 10 --balance 10000 &
          sleep 5

      - name: Start Crucible
        run: |
          cd apps/crucible
          bun run dev &
          sleep 15

      - name: Run E2E tests
        working-directory: apps/crucible
        run: bunx playwright test tests/synpress/00-smoke.spec.ts --config synpress.config.ts

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-crucible-results
          path: |
            apps/crucible/test-results/
            apps/crucible/synpress-report-*/
          retention-days: 7

  # ============================================================================
  # SUMMARY
  # ============================================================================
  e2e-summary:
    name: E2E Summary
    runs-on: ubuntu-latest
    needs: [e2e-gateway, e2e-bazaar, e2e-wallet, e2e-crucible]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║                     E2E TEST SUMMARY                             ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║ Gateway:  ${{ needs.e2e-gateway.result }}"
          echo "║ Bazaar:   ${{ needs.e2e-bazaar.result }}"
          echo "║ Wallet:   ${{ needs.e2e-wallet.result }}"
          echo "║ Crucible: ${{ needs.e2e-crucible.result }}"
          echo "╚══════════════════════════════════════════════════════════════════╝"

          # Fail if any required tests failed
          if [ "${{ needs.e2e-gateway.result }}" = "failure" ] || \
             [ "${{ needs.e2e-bazaar.result }}" = "failure" ] || \
             [ "${{ needs.e2e-wallet.result }}" = "failure" ]; then
            echo "E2E tests failed"
            exit 1
          fi
          echo "All E2E tests passed or were skipped"

